<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartShop AI - Full Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .card-premium { 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }
        .card-premium:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 25px 50px -5px rgba(0, 0, 0, 0.15);
        }
        .store-lidl { background: linear-gradient(135deg, #0050aa, #003d82); }
        .store-biedronka { background: linear-gradient(135deg, #e31e24, #b01419); }
        .store-auchan { background: linear-gradient(135deg, #ff6900, #e55100); }
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .notification { 
            transform: translateX(100%); 
            transition: transform 0.3s ease-in-out; 
        }
        .notification.show { 
            transform: translateX(0); 
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-blue-50 to-purple-50 min-h-screen">
    <!-- Notification Container -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 gradient-primary rounded-2xl flex items-center justify-center floating-animation">
                        <i data-lucide="shopping-cart" class="text-white w-7 h-7"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                            SmartShop AI
                        </h1>
                        <p class="text-xs text-gray-500">Full Application</p>
                    </div>
                </div>
                
                <nav class="hidden lg:flex space-x-1">
                    <button onclick="showSection('home')" class="px-4 py-2 rounded-xl bg-blue-500 text-white font-medium">Dashboard</button>
                    <button onclick="showSection('products')" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-white/50">Produkty</button>
                    <button onclick="showSection('shopping-list')" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-white/50">Lista Zakup√≥w</button>
                    <button onclick="showSection('analytics')" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-white/50">Analityka</button>
                </nav>
                
                <div class="flex items-center space-x-3">
                    <button id="refreshDataBtn" onclick="refreshAllData()" class="p-2 rounded-xl text-gray-600 hover:bg-white/50 transition-all">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>
                    <div class="text-sm text-gray-500">
                        Status: <span id="apiStatus" class="font-medium text-green-600">Online</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Home Section -->
        <div id="home-section" class="section">
            <!-- Search Bar -->
            <div class="mb-8">
                <div class="max-w-2xl mx-auto">
                    <div class="flex gap-4">
                        <div class="flex-1 relative">
                            <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                            <input 
                                type="text" 
                                placeholder="Wyszukaj produkty (np. mleko, chleb)"
                                class="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-200 outline-none"
                                id="globalSearch"
                            >
                        </div>
                        <button onclick="searchProducts()" class="gradient-primary text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </button>
                        <button onclick="triggerScraping()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-700 transition-all">
                            <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Dashboard -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 card-premium">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="package" class="text-blue-600 w-6 h-6"></i>
                        </div>
                        <span id="productsCount" class="text-2xl font-bold text-blue-600">0</span>
                    </div>
                    <h3 class="font-semibold text-gray-900">Produkty</h3>
                    <p class="text-sm text-gray-500">W bazie danych</p>
                </div>
                
                <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 card-premium">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="trending-down" class="text-green-600 w-6 h-6"></i>
                        </div>
                        <span id="savingsAmount" class="text-2xl font-bold text-green-600">0 PLN</span>
                    </div>
                    <h3 class="font-semibold text-gray-900">Oszczƒôdno≈õci</h3>
                    <p class="text-sm text-gray-500">Miesiƒôczne</p>
                </div>
                
                <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 card-premium">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="store" class="text-purple-600 w-6 h-6"></i>
                        </div>
                        <span class="text-2xl font-bold text-purple-600">3</span>
                    </div>
                    <h3 class="font-semibold text-gray-900">Sklepy</h3>
                    <p class="text-sm text-gray-500">Aktywne</p>
                </div>
                
                <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 card-premium">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="bell" class="text-red-600 w-6 h-6"></i>
                        </div>
                        <span id="alertsCount" class="text-2xl font-bold text-red-600">0</span>
                    </div>
                    <h3 class="font-semibold text-gray-900">Alarmy</h3>
                    <p class="text-sm text-gray-500">Aktywne</p>
                </div>
            </div>

            <!-- AI Recommendations -->
            <div class="bg-white/80 backdrop-blur-lg rounded-2xl p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i data-lucide="brain" class="w-6 h-6 mr-2 text-purple-600"></i>
                    AI Rekomendacje
                </h3>
                <div id="aiRecommendations" class="space-y-4">
                    <!-- AI recommendations will be loaded here -->
                </div>
            </div>

            <!-- Recent Products -->
            <div class="bg-white/80 backdrop-blur-lg rounded-2xl p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Najnowsze Produkty</h3>
                <div id="recentProducts" class="grid gap-4">
                    <!-- Recent products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products-section" class="section hidden">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Katalog Produkt√≥w</h2>
                <div class="flex gap-4 mb-4">
                    <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="all">Wszystkie kategorie</option>
                    </select>
                    <select id="sortFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="name">Sortuj po nazwie</option>
                        <option value="price">Sortuj po cenie</option>
                        <option value="savings">Sortuj po oszczƒôdno≈õciach</option>
                    </select>
                </div>
            </div>
            <div id="productsGrid" class="grid gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Shopping List Section -->
        <div id="shopping-list-section" class="section hidden">
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-white/80 backdrop-blur-lg rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Twoja Lista Zakup√≥w</h3>
                    <div id="shoppingListContainer">
                        <!-- Shopping list will be loaded here -->
                    </div>
                    <button onclick="optimizeRoute()" class="w-full mt-4 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                        üöÄ Optymalizuj Trasƒô
                    </button>
                </div>
                
                <div class="bg-white/80 backdrop-blur-lg rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Optymalna Trasa</h3>
                    <div id="optimizedRoute">
                        <!-- Optimized route will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics-section" class="section hidden">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Analityka i Raporty</h2>
            
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white/80 backdrop-blur-lg rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Historia Cen</h3>
                    <canvas id="priceChart" width="400" height="200"></canvas>
                </div>
                
                <div class="bg-white/80 backdrop-blur-lg rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Oszczƒôdno≈õci</h3>
                    <canvas id="savingsChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="bg-white/80 backdrop-blur-lg rounded-2xl p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Aktywne Alarmy Cenowe</h3>
                <div id="priceAlerts">
                    <!-- Price alerts will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3001/api' : '/api';
        
        // Global state
        let currentSection = 'home';
        let products = [];
        let shoppingList = [];
        let recommendations = [];
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initializeApp();
        });

        // App initialization
        async function initializeApp() {
            showNotification('üöÄ SmartShop AI ≈Çaduje siƒô...', 'info');
            
            try {
                await Promise.all([
                    loadProducts(),
                    loadShoppingList(),
                    loadAIRecommendations(),
                    loadPriceAlerts(),
                    checkAPIStatus()
                ]);
                
                updateDashboard();
                showNotification('‚úÖ Aplikacja za≈Çadowana pomy≈õlnie!', 'success');
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('‚ö†Ô∏è B≈ÇƒÖd inicjalizacji - u≈ºywam danych demo', 'warning');
                loadDemoData();
            }
        }

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', endpoint, error);
                // Return demo data as fallback
                return getDemoData(endpoint);
            }
        }

        // Demo data fallback
        function getDemoData(endpoint) {
            const demoData = {
                '/products': {
                    success: true,
                    data: [
                        {
                            id: '1',
                            name: 'Mleko UHT 3.2% 1L',
                            description: '≈Åaciate, ≈õwie≈ºe mleko UHT',
                            category: 'Nabia≈Ç',
                            brand: '≈Åaciate',
                            image: 'https://images.unsplash.com/photo-1563636619-e9143da7973b?w=200&h=200&fit=crop',
                            rating: 4.8,
                            reviewCount: 2341,
                            prices: [
                                { store: 'LIDL', price: 3.49, isLowest: true, discount: 0.7 },
                                { store: 'Biedronka', price: 3.99, isLowest: false, discount: 0.2 },
                                { store: 'Auchan', price: 4.19, isLowest: false, discount: 0 }
                            ]
                        },
                        {
                            id: '2',
                            name: 'Chleb ≈ªytni 500g',
                            description: 'Tradycyjny chleb ≈ºytni',
                            category: 'Pieczywo',
                            brand: 'Kaszubski',
                            image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=200&h=200&fit=crop',
                            rating: 4.6,
                            reviewCount: 1289,
                            prices: [
                                { store: 'Biedronka', price: 2.89, isLowest: true, discount: 0.6 },
                                { store: 'LIDL', price: 3.19, isLowest: false, discount: 0.3 },
                                { store: 'Auchan', price: 3.49, isLowest: false, discount: 0 }
                            ]
                        }
                    ]
                },
                '/ai/recommendations': {
                    success: true,
                    data: [
                        {
                            id: '1',
                            type: 'product',
                            title: 'Sugerujemy dodaƒá:',
                            message: 'Jajka - promocja w LIDL -25%',
                            action: 'add_to_list',
                            priority: 'high'
                        }
                    ]
                },
                '/shopping-list': {
                    success: true,
                    data: [
                        {
                            id: '1',
                            name: 'Zakupy Tygodniowe',
                            items: [],
                            totalAmount: 0,
                            estimatedSavings: 0
                        }
                    ]
                },
                '/prices/alerts': {
                    success: true,
                    data: []
                }
            };
            
            return demoData[endpoint] || { success: false, data: [] };
        }

        // Data loading functions
        async function loadProducts() {
            const response = await apiCall('/products');
            if (response.success) {
                products = response.data;
                renderProducts();
                updateProductsCount();
            }
        }

        async function loadShoppingList() {
            const response = await apiCall('/shopping-list');
            if (response.success && response.data.length > 0) {
                shoppingList = response.data[0].items || [];
                renderShoppingList();
            }
        }

        async function loadAIRecommendations() {
            const response = await apiCall('/ai/recommendations', {
                method: 'POST',
                body: JSON.stringify({ userId: 'demo', currentList: shoppingList })
            });
            if (response.success) {
                recommendations = response.data;
                renderAIRecommendations();
            }
        }

        async function loadPriceAlerts() {
            const response = await apiCall('/prices/alerts');
            if (response.success) {
                renderPriceAlerts(response.data);
                updateAlertsCount(response.data.length);
            }
        }

        async function checkAPIStatus() {
            try {
                await apiCall('/health');
                document.getElementById('apiStatus').textContent = 'Online';
                document.getElementById('apiStatus').className = 'font-medium text-green-600';
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Demo Mode';
                document.getElementById('apiStatus').className = 'font-medium text-yellow-600';
            }
        }

        // Rendering functions
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const recentGrid = document.getElementById('recentProducts');
            
            const productHTML = products.map(product => `
                <div class="bg-white rounded-xl p-6 shadow-lg card-premium">
                    <div class="flex gap-4">
                        <img src="${product.image}" alt="${product.name}" class="w-24 h-24 object-cover rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 mb-2">${product.name}</h4>
                            <p class="text-gray-600 text-sm mb-3">${product.description}</p>
                            <div class="flex gap-2 mb-3">
                                ${product.prices.map(price => `
                                    <span class="px-2 py-1 rounded text-xs font-medium ${getStoreClass(price.store)}">
                                        ${price.store}: ${price.price} PLN
                                        ${price.isLowest ? 'üèÜ' : ''}
                                    </span>
                                `).join('')}
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-green-600 font-semibold">
                                    üí∞ Oszczƒôdno≈õƒá: ${Math.max(...product.prices.map(p => p.discount))} PLN
                                </span>
                                <button onclick="addToShoppingList('${product.id}')" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                                    Dodaj do Listy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            if (grid) grid.innerHTML = productHTML;
            if (recentGrid) recentGrid.innerHTML = productHTML;
        }

        function renderAIRecommendations() {
            const container = document.getElementById('aiRecommendations');
            if (!container) return;
            
            const html = recommendations.map(rec => `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i data-lucide="lightbulb" class="text-white w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-blue-900">${rec.title}</h4>
                            <p class="text-blue-700 mt-1">${rec.message}</p>
                            ${rec.action ? `
                                <button onclick="handleRecommendationAction('${rec.action}', '${rec.productId || ''}')" 
                                        class="text-blue-600 text-sm font-medium mt-2 hover:underline">
                                    Akcja
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function renderShoppingList() {
            const container = document.getElementById('shoppingListContainer');
            if (!container) return;
            
            if (shoppingList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Lista zakup√≥w jest pusta</p>';
                return;
            }
            
            const html = shoppingList.map(item => `
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg mb-2">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" class="w-5 h-5 text-blue-600">
                        <span>${item.name}</span>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${item.price} PLN</div>
                        <div class="text-sm text-gray-500">${item.selectedStore}</div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function renderPriceAlerts(alerts) {
            const container = document.getElementById('priceAlerts');
            if (!container) return;
            
            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Brak aktywnych alarm√≥w cenowych</p>';
                return;
            }
            
            const html = alerts.map(alert => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg mb-2">
                    <div>
                        <h4 class="font-semibold">${alert.productName}</h4>
                        <p class="text-sm text-gray-600">Cel: ${alert.targetPrice} PLN</p>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${alert.currentPrice} PLN</div>
                        <div class="text-sm ${alert.status === 'triggered' ? 'text-green-600' : 'text-yellow-600'}">
                            ${alert.status === 'triggered' ? 'OsiƒÖgniƒôte!' : 'Aktywny'}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Helper functions
        function getStoreClass(store) {
            const classes = {
                'LIDL': 'bg-blue-100 text-blue-800',
                'Biedronka': 'bg-red-100 text-red-800',
                'Auchan': 'bg-orange-100 text-orange-800'
            };
            return classes[store] || 'bg-gray-100 text-gray-800';
        }

        function updateDashboard() {
            updateProductsCount();
            updateSavingsAmount();
            updateAlertsCount(0);
        }

        function updateProductsCount() {
            const element = document.getElementById('productsCount');
            if (element) element.textContent = products.length;
        }

        function updateSavingsAmount() {
            const totalSavings = products.reduce((sum, product) => 
                sum + Math.max(...product.prices.map(p => p.discount)), 0
            );
            const element = document.getElementById('savingsAmount');
            if (element) element.textContent = `${totalSavings.toFixed(2)} PLN`;
        }

        function updateAlertsCount(count) {
            const element = document.getElementById('alertsCount');
            if (element) element.textContent = count;
        }

        // Action functions
        async function searchProducts() {
            const searchTerm = document.getElementById('globalSearch').value;
            if (!searchTerm) return;
            
            showNotification(`üîç Szukam: "${searchTerm}"...`, 'info');
            
            try {
                const response = await apiCall(`/products?search=${encodeURIComponent(searchTerm)}`);
                if (response.success) {
                    products = response.data;
                    renderProducts();
                    showSection('products');
                    showNotification(`‚úÖ Znaleziono ${products.length} produkt√≥w`, 'success');
                }
            } catch (error) {
                showNotification('‚ö†Ô∏è B≈ÇƒÖd wyszukiwania', 'error');
            }
        }

        async function addToShoppingList(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const lowestPrice = product.prices.reduce((min, p) => p.price < min.price ? p : min);
            
            const newItem = {
                id: Date.now().toString(),
                productId: productId,
                name: product.name,
                quantity: 1,
                selectedStore: lowestPrice.store,
                price: lowestPrice.price,
                totalPrice: lowestPrice.price
            };
            
            shoppingList.push(newItem);
            renderShoppingList();
            showNotification(`‚úÖ ${product.name} dodane do listy!`, 'success');
        }

        async function triggerScraping() {
            const button = document.querySelector('button[onclick="triggerScraping()"]');
            const originalHTML = button.innerHTML;
            
            button.innerHTML = '<div class="loading-spinner"></div>';
            button.disabled = true;
            
            showNotification('üîÑ Rozpoczynam aktualizacjƒô cen...', 'info');
            
            try {
                const response = await apiCall('/scraper/run', {
                    method: 'POST',
                    body: JSON.stringify({ stores: ['LIDL', 'Biedronka', 'Auchan'] })
                });
                
                if (response.success) {
                    showNotification('‚úÖ Ceny zaktualizowane pomy≈õlnie!', 'success');
                    await loadProducts(); // Reload products with new prices
                } else {
                    showNotification('‚ö†Ô∏è B≈ÇƒÖd aktualizacji cen', 'warning');
                }
            } catch (error) {
                showNotification('‚ùå Nie mo≈ºna zaktualizowaƒá cen', 'error');
            } finally {
                button.innerHTML = originalHTML;
                button.disabled = false;
                lucide.createIcons();
            }
        }

        async function optimizeRoute() {
            if (shoppingList.length === 0) {
                showNotification('‚ö†Ô∏è Lista zakup√≥w jest pusta', 'warning');
                return;
            }
            
            showNotification('üöÄ Optymalizujƒô trasƒô...', 'info');
            
            try {
                const response = await apiCall('/shopping-list/1/optimize', {
                    method: 'POST'
                });
                
                if (response.success) {
                    renderOptimizedRoute(response.data);
                    showNotification('‚úÖ Trasa zoptymalizowana!', 'success');
                }
            } catch (error) {
                showNotification('‚ö†Ô∏è B≈ÇƒÖd optymalizacji trasy', 'error');
            }
        }

        function renderOptimizedRoute(routeData) {
            const container = document.getElementById('optimizedRoute');
            if (!container) return;
            
            const html = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-900">Optymalna Trasa:</h4>
                        <p class="text-green-700">${routeData.route.join(' ‚Üí ')}</p>
                        <div class="grid grid-cols-2 gap-4 mt-3 text-sm">
                            <div>‚è±Ô∏è Czas: ${routeData.estimatedTime} min</div>
                            <div>üí∞ Oszczƒôdno≈õƒá: ${routeData.totalSavings} PLN</div>
                        </div>
                    </div>
                    
                    ${routeData.storeDetails.map(store => `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold">${store.store}</h5>
                            <p class="text-sm text-gray-600">${store.items.length} produkt√≥w</p>
                            <p class="font-semibold">Razem: ${store.subtotal.toFixed(2)} PLN</p>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function handleRecommendationAction(action, productId) {
            switch (action) {
                case 'add_to_list':
                    if (productId) addToShoppingList(productId);
                    break;
                case 'buy_now':
                    showNotification('üõí Przekierowanie do sklepu...', 'info');
                    break;
                default:
                    showNotification('‚ÑπÔ∏è Akcja wykonana', 'info');
            }
        }

        async function refreshAllData() {
            const button = document.getElementById('refreshDataBtn');
            const icon = button.querySelector('i');
            
            icon.style.animation = 'spin 1s linear infinite';
            
            try {
                await initializeApp();
                showNotification('üîÑ Dane od≈õwie≈ºone!', 'success');
            } catch (error) {
                showNotification('‚ö†Ô∏è B≈ÇƒÖd od≈õwie≈ºania', 'error');
            } finally {
                icon.style.animation = '';
            }
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show target section
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('nav button').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-xl text-gray-600 hover:bg-white/50';
            });
            
            event.target.className = 'px-4 py-2 rounded-xl bg-blue-500 text-white font-medium';
            
            currentSection = sectionName;
            
            // Load section-specific data
            if (sectionName === 'analytics') {
                loadAnalytics();
            }
        }

        // Analytics
        function loadAnalytics() {
            // Price chart
            const priceCtx = document.getElementById('priceChart');
            if (priceCtx) {
                new Chart(priceCtx, {
                    type: 'line',
                    data: {
                        labels: ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'Sb', 'Nd'],
                        datasets: [{
                            label: '≈örednia cena (PLN)',
                            data: [3.89, 3.85, 3.82, 3.79, 3.76, 3.73, 3.70],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
            
            // Savings chart
            const savingsCtx = document.getElementById('savingsChart');
            if (savingsCtx) {
                new Chart(savingsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['LIDL', 'Biedronka', 'Auchan'],
                        datasets: [{
                            data: [45, 35, 20],
                            backgroundColor: ['#0050aa', '#e31e24', '#ff6900']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }

        // Notifications
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const id = Date.now();
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.id = `notification-${id}`;
            notification.className = `notification ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg max-w-sm`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="hideNotification('${id}')" class="ml-4 text-white">√ó</button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto hide after 5 seconds
            setTimeout(() => hideNotification(id), 5000);
        }

        function hideNotification(id) {
            const notification = document.getElementById(`notification-${id}`);
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }
        }

        // Load demo data if API is not available
        function loadDemoData() {
            products = getDemoData('/products').data;
            recommendations = getDemoData('/ai/recommendations').data;
            renderProducts();
            renderAIRecommendations();
            updateDashboard();
        }

        // Enter key for search
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.activeElement.id === 'globalSearch') {
                searchProducts();
            }
        });
    </script>
</body>
</html> 